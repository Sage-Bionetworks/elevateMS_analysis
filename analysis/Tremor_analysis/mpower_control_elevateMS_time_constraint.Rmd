---
title: "Classify case-control in kinetic state tremors using random forest models with median and iqr features, for Multiple Sclerosis. The training is done using controls from mpower and elevateMS, and cases from elevateMS"
author: "Meghasyam Tummalacherla"
author options: "This would not have been possible without Thanneer Perumal's skeleton code"
date: "`r base::date()`"
output: html_document
editor_options: 
chunk_output_type: console
---
```{r knit2synapse, eval=FALSE}
library(synapser)
library(knit2synapse)

synapser::synLogin()

knit2synapse::createAndKnitToFolderEntity(file = "./mpower_control_elevateMS_time_constraint.Rmd",
                                          parentId = "syn19120636",
                                          folderName = "elevateMS action tremor test (mpower PD action tremor train)(no scaling)(atleast 2 records)(time constraint)")
```

```{r libs.and.functions, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
###########################################################
## Required libraries and analysis functions
###########################################################
## It is assumed your working directory is where this file
source('analysis_functions.R')

loadRequiredLibraries()

synapser::synLogin()

cl = makeCluster(detectCores()-2)
registerDoParallel(cl)

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE,
  cache.lazy = FALSE)
```

```{r github.synapse.parameters, include=FALSE, cache=TRUE}
###########################################################
## Github Parameters and links
###########################################################
# Synapse parameters
parentId = 'syn19120636';
activityName = 'elevateMS Kinetic tremor case-control classification';
activityDescription = 'Classify case-control in kinetic state tremors using random forest models with median and iqr features (time constraint), for Multiple Sclerosis. The training is done using controls from mpower and elevateMS, and cases from elevateMS'

# Github link
gtToken = '~/github_token.txt'
githubr::setGithubToken(as.character(read.table(gtToken)$V1))

thisFileName <- 'mpower_control_elevateMS_time_constraint.Rmd'

thisRepo <- getRepo(repository = "itismeghasyam/elevateMS_analysis", ref="branch", refName='master')
thisFile <- getPermlink(repository = thisRepo, repositoryPath=paste0('analysis/Tremor_analysis/',thisFileName))
```

#### Download age matched elevateMS (control + cases) + mpower (cases) pool
```{r age.matched.healthcodes, fig.height=5, fig.width=10}
###########################################################
## Download age matched healthcodes
###########################################################
age.records.matched.id = 'syn19123754'
age.records.matched.syn = synapser::synGet(age.records.matched.id)
age.records.matched = read.csv(age.records.matched.syn$path, sep = '\t')
all.used.ids = age.records.matched.id

p1 = ggplot(age.records.matched, aes(x = factor(MS), y = age)) + geom_boxplot()
p2 = ggplot(age.records.matched, aes(x = MS)) + geom_bar()
p3 = ggplot(age.records.matched, aes(x = log10(n), color = factor(MS))) + geom_density() + xlab('log10(# Windows)')
ggpubr::ggarrange(p2,p1, p3,ncol = 3, nrow = 1)
```

```{r get.subset.summarized.ftrs}
###########################################################
## Download healthCode wise summarized features
###########################################################
summarized.ftrs.healthCode.id = 'syn20503296'
summarized.ftrs.healthCode = read.csv(synapser::synGet(summarized.ftrs.healthCode.id)$path, sep = '\t')
all.used.ids <- c(all.used.ids, summarized.ftrs.healthCode.id)

###########################################################
## Download record wise summarized features
###########################################################
summarized.ftrs.record.id = 'syn20503297'
summarized.ftrs.record = read.csv(synapser::synGet(summarized.ftrs.record.id)$path, sep = '\t')
all.used.ids <- c(all.used.ids, summarized.ftrs.record.id)

###########################################################
## Download demohgraphics data for elevateMS
###########################################################
demo.tbl.id.ms = 'syn17115631' # elevateMS_baselineCharacteristics
demo.tbl.syn.ms <- synapser::synGet(demo.tbl.id.ms)
demo.tbl.ms <- demo.tbl.syn.ms$path %>% read.csv(sep = '\t')
all.used.ids <- c(all.used.ids, demo.tbl.id.ms)
```

#### Compute model performance using identified features (from mpoweranalysis)
##### Evaluate model on training set (mpower + elevateMS) (alternate vs null model)
```{r all.rf.model}
dat.train <- summarized.ftrs.healthCode %>% 
  dplyr::filter(healthCode %in% age.records.matched$healthCode) %>% 
  dplyr::left_join(age.records.matched %>% 
                     dplyr::select(healthCode, MS, age, gender)) %>% 
  as.data.frame() %>% 
  droplevels() %>% 
  unique()

ftrs.to.evaluate <- setdiff(colnames(summarized.ftrs.healthCode), 'healthCode')
rf.mdl.caret <- getAlternateNullModelPerformance(dat.train)
```

##### Model performance
```{r all.print.results, fig.height=5, fig.width=12, cache = FALSE}
# Display number of data points used
writeLines('Number of data points used')
kable(rf.mdl.caret$alternateModel[[1]]$param)

# Plot auroc and aupr
writeLines('Average performance on 100 runs')
tmp = printModelPerformance(rf.mdl.caret, 'Caret based features')
p = gridExtra::tableGrob(tmp$performance, rows = NULL)
p = ggpubr::ggarrange(tmp$plot, p, nrow = 1, ncol = 2)
p

# Plot important variables in all model
writeLines('Features present in 70% of the models are')
printTopFeatures(rf.mdl.caret$alternateModel) %>%
  paste(collapse = ', ') %>%
  data.frame(Important_Features = .) %>%
  kable()
```

#### Evaluate Kinetic Model on elevateMS by training on mPower+elevateMS age matched data (remaining healthCodes)
```{r model.result}
dat.test <- summarized.ftrs.healthCode %>%
  dplyr::filter(!(healthCode %in% age.records.matched$healthCode)) %>%
  dplyr::left_join(demo.tbl.ms %>%
                     dplyr::select(healthCode, gender, age, MS = dataGroups)) %>%
  dplyr::filter(MS %in% c('ms_patient','control'),
                gender %in% c('male','female'),
                !is.na(age), !is.na(MS), !is.na(gender)) %>% #remove NAs
  dplyr::mutate(MS = factor(MS, levels = c('control','ms_patient')),
                MS = as.numeric(MS) - 1) %>% 
  unique() %>% 
  droplevels()

# Build rf model using train data
rf.mdl = getRfModel(dat.train, responseNames = 'MS')

# Predict reponse of test data
rf.prediction = getPrediction(dat.test, rf.mdl)

# Get performance metrics of the predictions
mdl.performance = getModelPerformanceMetrics(rf.prediction, dat.test)

writeLines(c('Number of Kinetic features chosen for analysis : ',as.character(length(ftrs.to.evaluate))))
writeLines(c('Number of healthCodes in testset : ',as.character(length(dat.test$healthCode))))
writeLines(c('Number of cases in testset : ',as.character(sum(dat.test$MS == 1))))
writeLines(c('Number of controls in testset : ',as.character(sum(dat.test$MS == 0))))
writeLines('Prediction on elevateMS after training on age matched mPower + elevateMS data')
kable(mdl.performance)
```


#### Evaluate Kinetic Model on elevateMS by training on mPower+elevateMS age matched data (records of the age matched (elevateMS only) healthCodes)
```{r model.result.1}
dat.test <- summarized.ftrs.record %>%
  dplyr::filter((healthCode %in% age.records.matched$healthCode)) %>% 
  dplyr::select('healthCode','recordId','Assay',one_of(ftrs.to.evaluate)) %>% 
  dplyr::left_join(demo.tbl.ms %>%
                     dplyr::select(healthCode, gender, age, MS = dataGroups)) %>%
  dplyr::filter(MS %in% c('ms_patient','control'),
                gender %in% c('male','female'),
                !is.na(age), !is.na(MS), !is.na(gender)) %>% #remove NAs
  dplyr::mutate(MS = factor(MS, levels = c('control','ms_patient')),
                MS = as.numeric(MS) - 1) %>% 
  unique() %>% 
  droplevels()

# Build rf model using train data
rf.mdl = getRfModel(dat.train, responseNames = 'MS')

# Predict reponse of test data
rf.prediction = getPrediction(dat.test, rf.mdl)

# Get performance metrics of the predictions
mdl.performance = getModelPerformanceMetrics(rf.prediction, dat.test)

writeLines(c('Number of Kinetic features chosen for analysis : ',as.character(length(ftrs.to.evaluate))))
writeLines(c('Number of records(left + right) in testset : ',as.character(length(dat.test$recordId))))
writeLines(c('Number of case records in testset : ',as.character(sum(dat.test$MS == 1))))
writeLines(c('Number of control records in testset : ',as.character(sum(dat.test$MS == 0))))
writeLines('Prediction on elevateMS records after training on age matched mPower + elevateMS data')
kable(mdl.performance)
```


#### Evaluate Kinetic Model on elevateMS by training on mPower+elevateMS age matched data ((records of the NON age matched (elevateMS only) healthCodes))
```{r model.result.2}
dat.test <- summarized.ftrs.record %>%
  dplyr::filter(!(healthCode %in% age.records.matched$healthCode)) %>% 
  dplyr::select('healthCode','recordId','Assay',one_of(ftrs.to.evaluate)) %>% 
  dplyr::left_join(demo.tbl.ms %>%
                     dplyr::select(healthCode, gender, age, MS = dataGroups)) %>%
  dplyr::filter(MS %in% c('ms_patient','control'),
                gender %in% c('male','female'),
                !is.na(age), !is.na(MS), !is.na(gender)) %>% #remove NAs
  dplyr::mutate(MS = factor(MS, levels = c('control','ms_patient')),
                MS = as.numeric(MS) - 1) %>% 
  unique() %>% 
  droplevels()

# Build rf model using train data
rf.mdl = getRfModel(dat.train, responseNames = 'MS')

# Predict reponse of test data
rf.prediction = getPrediction(dat.test, rf.mdl)

# Get performance metrics of the predictions
mdl.performance = getModelPerformanceMetrics(rf.prediction, dat.test)

writeLines(c('Number of Kinetic features chosen for analysis : ',as.character(length(ftrs.to.evaluate))))
writeLines(c('Number of records(left + right) in testset : ',as.character(length(dat.test$recordId))))
writeLines(c('Number of case records in testset : ',as.character(sum(dat.test$MS == 1))))
writeLines(c('Number of control records in testset : ',as.character(sum(dat.test$MS == 0))))
writeLines('Prediction on elevateMS records after training on age matched mPower + elevateMS data')
kable(mdl.performance)
```

### Store results in synapse
```{r syn.store, cache=FALSE, eval = TRUE}
CODE = Folder(name = 'elevateMS action tremor test (mpower PD action tremor train)(no scaling)(atleast 2 records)(time constraint)', 
              parentId = "syn19120636")
CODE = synStore(CODE)

# Save all coefficients and AUCs as RData
save(list = c('rf.mdl'), 
     file = 'AllImportanceScore.RData')
obj = File('AllImportanceScore.RData', 
           name = 'All importance scores with AUC', 
           parentId = CODE$properties$id)
obj = synStore(obj,activityName = activityName, 
               activityDescription = activityDescription, 
               used = all.used.ids, executed = thisFile)
res = paste0('https://www.synapse.org/#!Synapse:',obj$properties$id)
# stopCluster(cl)
```
[Results](`r res`)

### Source code in github
[Source Code](`r thisFile`)