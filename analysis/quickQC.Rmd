---
title: "ElevateMS - on-going summary"
output:
  html_document: default
  html_notebook: default
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
Sys.setenv(TZ='GMT')
library(synapseClient)
synapseLogin()
library(install.load)
install_load(c('tidyverse', 'data.table', 'lubridate'))
```


```{r}
masterTable <- "syn9758009"  #poorly named elevate-ms-appVersion
#remove all testing users and records created before Monday, August 14, 2017 12:00:00 AM (GMT)
userActivity <- synTableQuery(paste("select * from", masterTable, "WHERE dataGroups NOT LIKE '%test%' AND createdOn > 1502668800000"))
userActivity <- userActivity@values

#Data Manipulation
userActivity <- userActivity %>% dplyr::mutate(createdOnTimeZone = as.numeric(createdOnTimeZone)/100,
                                               createdOn = lubridate::ymd_hms(createdOn, tz='UTC'))


#get start dates for people 
userStartDates <- userActivity %>% dplyr::group_by(healthCode) %>% 
  dplyr::summarise(startDate = min(lubridate::date(createdOn)))

userActivity <- userActivity %>% inner_join(userStartDates)

userActivity <- userActivity %>% dplyr::mutate(createdOn_localTime = createdOn + lubridate::hours(createdOnTimeZone),
                                               day = as.numeric(lubridate::date(createdOn) - startDate ) + 1)
```

------

### Summary stats

1. Total users: `r n_distinct(userActivity$healthCode)`
2. MS patients: `r userActivity %>% dplyr::filter(dataGroups %like% 'ms_patient') %>% .$healthCode %>% n_distinct()`
3. Controls: `r userActivity %>% dplyr::filter(dataGroups %like% 'control') %>% .$healthCode %>% n_distinct()`






```{r}


table(userActivity$dataGroups) / nrow(userActivity) * 100

table(userActivity$originalTable)

View(userActivity)

```


```{r, eval=F}


#r sum(is.na(userActivity$dataGroups) | userActivity$dataGroups == '')

table(userActivity$appVersion)

unique(userActivity$dataGroups)

userActivity$createdOn


as.numeric(userActivity$createdOnTimeZone) / 100

str(userActivity)

table()

cat(names(table(userActivity$dataGroups)))
View(userActivity)

```










#### elevate-ms-appVersion
```{r, eval=F}
missingNess <- function(col){
  missingVals <- sum(is.na(col)) + sum(col == '', na.rm = T)
  (missingVals / length(col)) * 100
}

elevateMS_appVersion_table = "syn9758009"
appVersion <- synTableQuery(paste("select * from", elevateMS_appVersion_table))
appVersion <- appVersion@values
head(appVersion)
apply(appVersion, 2, missingNess)
```


```{r, eval=F}
elevateMS_walking_table = "syn9934066"
walkingTable <- synTableQuery(paste("select * from", elevateMS_walking_table))
walking <- walkingTable@values
apply(walking, 2, missingNess)
outFiles <- synDownloadTableColumns(walkingTable,"deviceMotion_walking_outbound.json")


sample_walking_File <-'syn7077340'
walkingJsonFile <- synGet(sample_walking_File)@filePath
walkingJsonFile
getWalkFeatures(walkingJsonFile)
library(mpowertools)

?mpowertools::getWalkFeatures
mpowertools::getWalkFeatures(outFiles[[1]])


outFiles[[1]]
 dat <- jsonlite::fromJSON(outFiles[[1]])
 dat1 <- jsonlite::fromJSON(walkingJsonFile)
 
 View(dat$items)
 colnames(dat$items)
 colnames(dat1)
 
 View(dat   )
 dat <- ShapeGaitData(dat)
    x <- dat$x
    y <- dat$y
    z <- dat$z

lapply(outFiles, function(x) mpowertools::getWalkFeatures(x))
```


```{r, eval=F}
dailyCheckins_table = "syn9758010"
dailyCheckin <- synTableQuery(paste("select * from", dailyCheckins_table))
dailyCheckin <- dailyCheckin@values
head(dailyCheckin)
apply(dailyCheckin, 2, missingNess)
apply(dailyCheckin, 2, table)

```



```{r, eval=F}
tapping_table = "syn9765504"
tapping_table_out <- synTableQuery(paste("select * from", tapping_table))
tapping <- tapping_table_out@values
head(tapping)
apply(tapping, 2, missingNess)
apply(dailyCheckin, 2, table)

tapping_left_files <- synDownloadTableColumns(walkingTable,"deviceMotion_walking_outbound.json")


syn9765504
```


```{r, eval=F}
symptomSuvery_table = "syn9765702"
symptomSuvery_table_out <- synTableQuery(paste("select * from", symptomSuvery_table))
symptomSurvey <- symptomSuvery_table_out@values
head(symptomSurvey)
apply(symptomSurvey, 2, missingNess)
apply(symptomSurvey, 2, table)
str(symptomSurvey)


#this could just become columns
symptomSurvey$symptomTiming.json.choiceAnswers[10]
```




```{r, eval=F}
factorsSuvery_table = "syn9819608"
factorsSuvery_table_out <- synTableQuery(paste("select * from", factorsSuvery_table))
factors <- factorsSuvery_table_out@values
apply(factors, 2, missingNess)
apply(symptomSurvey, 2, table)
str(symptomSurvey)

```


```{r, eval=F}
relapseSuvery_table = "syn9872551"
relapseSuvery_table_out <- synTableQuery(paste("select * from", relapseSuvery_table))
relapseSuvery <- relapseSuvery_table_out@values
apply(relapseSuvery, 2, missingNess)
head(relapseSuvery)

```


```{r, eval=F}
tremorActivity_table = "syn9920297"
tremorActivity_table <- synTableQuery(paste("select * from", tremorActivity_table))
tremorActivity <- tremorActivity_table@values
apply(tremorActivity, 2, missingNess)
head(relapseSuvery)


#https://www.synapse.org/#!Synapse:syn9920297/tables/
#two accel and tremor motion
# onboard - device motion processing ?
# skip hand - data still present sometime
```



